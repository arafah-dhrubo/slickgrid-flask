<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
  <link rel="stylesheet" href="{{ url_for('static', filename='slickgrid/css/slick.grid.css') }}" type="text/css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='slickgrid/css/examples.css') }}" type="text/css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='slickgrid/css/slick.gridmenu.css') }}" type="text/css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='slickgrid/css/slick.columnpicker.css') }}" type="text/css"/>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" crossorigin="anonymous">
  <style>

  </style>
</head>
<body>
<div style="position:relative">
  <div style="width:600px;">
    <div id="myGrid" style="width:100%;height:500px;"></div>
  </div>
  <div class="options-panel">
    &lt;== Top Right Corner
    <h2>Demonstrates:</h2>
    <ul>
      <li>This example demonstrates using the Slick.Controls.GridMenu to add a Grid Menu (hamburger menu on top right of the grid)</li>
      <li>Possibility to add custom menu items via a simple array provided to the grid options (same concept as the header menu plugin)</li>
      <li>Includes column picker list.</li>
      <li>Optional title for the custom menu items (top section)</li>
      <li>Optional title for the columns list (bottom section)</li>
      <li>To dismiss the Grid Menu, user can click on the "x" on top right corner or anywhere outside of the Grid Menu</li>
      <li>Possibility to attach the Grid Menu to an external button (try clicking on the button below).</li>
      <li>You can also use some events like "onMenuClose()" and to trigger a resize of the columns with "autosizeColumns()" when "forceFitColumns: false"</li>
      <p>
        <button id="external-gridmenu" onclick="toggleGridMenu(event)"><img src="/static/slickgrid/images/drag-handle.png"/> Grid Menu</button>
      </p>
      <p>
        Always show vertical scroll (with "alwaysShowVerticalScroll" flag), so that it works with small and large dataset.
        Not using this flag, might have side effect on the UI with the Grid Menu overlapping with the data in background.
      </p>
      <div style="margin-bottom:10px">
        <button onclick="loadData(15)">15 rows</button>
        <button onclick="loadData(5000)">5000 rows</button>
        <button id="toggle-sorting" onclick="toggleSorting(event)">Toggle Sorting</button>
      </div>
      <h2>View Source:</h2>
      <ul>
          <li><A href="https://github.com/6pac/SlickGrid/blob/master/examples/example-grid-menu.html" target="_sourcewindow"> View the source for this example on Github</a></li>
      </ul>
    </ul>
  </div>
</div>

<script src="{{ url_for('static', filename='slickgrid/js/firebugx.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/jquery-3.1.0.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs/Sortable.min.js"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.core.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.interactions.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.dataview.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.grid.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.columnpicker.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.gridmenu.js') }}"></script>
<script src="{{ url_for('static', filename='slickgrid/js/slick.state.js') }}"></script>
<script>
  var dataView;
  var grid;
  var data = [];
  var columnpicker;
  var gridMenuControl;


  var options = {
    enableCellNavigation: true,
    explicitInitialization: true,
    forceFitColumns: false,
    alwaysShowVerticalScroll: true, // this is necessary when using Grid Menu with a small dataset
    columnPicker: {
      fadeSpeed: 100,
      columnTitle: "Columns",
      hideForceFitButton: false,
      hideSyncResizeButton: false,
      forceFitTitle: "Force fit columns",
      syncResizeTitle: "Synchronous resize",
    },

    // gridMenu Object is optional
    // when not passed, it will act as a regular Column Picker (with default Grid Menu image of drag-handle.png)
    gridMenu: {
      useClickToRepositionMenu: false, // defaults to true (false would use the icon offset to reposition the grid menu)
      menuUsabilityOverride: function (args) {
        // we could disable the menu entirely by returning false
        return true;
      },
      columnTitle: "Columns",
      hideForceFitButton: false,
      hideSyncResizeButton: false,
      // iconImage: "../images/drag-handle.png", // this is the Grid Menu icon (hamburger icon)
      iconCssClass: "fa fa-bars",    // you can provide iconImage OR iconCssClass
      leaveOpen: false,                 // do we want to leave the Grid Menu open after a command execution? (false by default)
      // menuWidth: 18,                 // width that will be use to resize the column header container (18 by default)
      resizeOnShowHeaderRow: true,
    }
  };
  var columns = [];
  var columnFilters = {};
  var sortcol = "id";
  var sortdir = 1;
  const allFields = {{ fields | tojson | safe }}

  for (var i = 0; i < allFields.length; i++) {
    columns.push({
      id: i,
      name: allFields[i].name,
      field: allFields[i].field,
      width: allFields[i].width,
      rerenderOnResize: false,
      resizable:true,
      selectable:true,
      sortable: true,
      defaultSortAsc: true,
      focusable: true
    });
  }

  function comparer(a, b) {
      var x = a[sortcol], y = b[sortcol];
      return (x == y ? 0 : (x > y ? 1 : -1));
    }

  function loadData(count) {
    data = [];
    for (var i = 0; i < count; i++) {
      var d = (data[i] = {});
      d["id"] = i;
      for (var j = 0; j < columns.length; j++) {
        d[j] = Math.round(Math.random() * 10);
      }
    }
    dataView.setItems({{ list | tojson | safe }});
  }

  $(function () {
    dataView = new Slick.Data.DataView();
    grid = new Slick.Grid("#myGrid", dataView, allFields, options);
    columnpicker = new Slick.Controls.ColumnPicker(columns, grid, options);
    gridMenuControl = new Slick.Controls.GridMenu(columns, grid, options);

    var statePersistor = new Slick.State({
      cid: 'sample-grid',
      defaultColumns: columns
    });

    if(!localStorage.getItem('slickgrid:sample-grid')){
      const columns_id = []
      for (var i = 0; i < allFields.length; i++) {
      columns_id.push({
        id: i,
        width: allFields[i].width
      })};

      localStorage.setItem('slickgrid:sample-grid', JSON.stringify(
              {"columns":columns_id}
      ))
    }

    dataView.onRowCountChanged.subscribe(function (e, args) {
      grid.updateRowCount();
      grid.render();
    });

    dataView.onRowsChanged.subscribe(function (e, args) {
      grid.invalidateRows(args.rows);
      grid.render();
    });

    grid.init();

    dataView.setItems({{ list | tojson | safe }});

    // subscribe to event when column visibility is changed via the menu
    gridMenuControl.onColumnsChanged.subscribe(function(e, args) {
      console.log('Columns changed via the menu');
      statePersistor.save();
    });

    grid.registerPlugin(statePersistor);

    grid.onSort.subscribe(function (e, args) {
      sortdir = args.sortAsc ? 1 : -1;
      sortcol = args.sortCol.field;
      dataView.sort(comparer, args.sortAsc);
    });

    statePersistor.restore()
    .then(function (state) {
      grid.setSortColumns(state.sortcols);
      var columns = grid.getColumns();
      var sortCols = $.map(grid.getSortColumns(), function (col) {
        return {
          sortCol: columns[grid.getColumnIndex(col.columnId)],
          sortAsc: col.sortAsc
        };
      });
      sortDataView(sortCols);
    });
  })
</script>
</body>
</html>